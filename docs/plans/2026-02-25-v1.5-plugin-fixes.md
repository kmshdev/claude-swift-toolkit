# v1.5 Plugin Fixes — Issues Found During Ciphyr Build Test

> **For Claude:** REQUIRED SUB-SKILL: Use superpowers:executing-plans to implement this plan task-by-task.

**Goal:** Fix all workflow gaps, agent swarm issues, skill deficiencies, and documentation gaps discovered during the real-world Ciphyr app build test.

**Architecture:** 16 issues across 4 categories. Grouped into 8 implementation tasks ordered by dependency — workflow fixes first (they define the structure), then agent swarm wiring, then skill content, then docs.

**Tech Stack:** Markdown skill files, agent frontmatter YAML, command markdown

---

### Task 1: Add Review-Fix Loop to `app-development-workflow`

**Files:**
- Modify: `skills/app-development-workflow/SKILL.md` — Phase 5 section

**Step 1: Read the current Phase 5 section**
Read `skills/app-development-workflow/SKILL.md` and locate Phase 5.

**Step 2: Replace Phase 5 with an iterative review-fix loop**
Phase 5 should become:

```markdown
### Phase 5 — Review (iterative)

**Exit criterion:** No CRITICAL or MAJOR findings remain. Grade: A- or better (0 FAIL sections in code-analyzer output).

1. **Run review swarm:** `/review` dispatches `swift-reviewer` + `code-reviewer` in parallel
2. **Triage findings:** Classify each as CRITICAL (fix now), MAJOR (fix now), MINOR (fix later), SUGGESTION (backlog)
3. **Fix CRITICAL and MAJOR findings** — apply fixes one category at a time
4. **Rebuild:** `/build` to verify fixes compile
5. **Re-run review swarm** — repeat steps 1-4 until exit criterion met
6. **Apply optional polish:** `/refactor-view` for view structure, `/swift-style` for conventions
7. **Proceed to Phase 6** only when review passes at A- or better
```

**Step 3: Verify the skill has the loop construct and exit criterion**
Grep for "Exit criterion" and "re-run review" in the file.

**Step 4: Commit**
```bash
git add skills/app-development-workflow/SKILL.md
git commit -m "fix: add iterative review-fix loop with A- exit criterion to Phase 5"
```

---

### Task 2: Create `/review` Command

**Files:**
- Create: `commands/review.md`

**Step 1: Write the review command**

```markdown
---
description: Run comprehensive code review with parallel Swift-specific and general quality agents
argument-hint: [file paths or "all"]
allowed-tools: Read, Grep, Glob
---

# Code Review: $ARGUMENTS

## Workflow

1. **Identify scope:**
   - If `$ARGUMENTS` specifies files → review those files
   - If `$ARGUMENTS` is "all" or empty → identify changed files via `git diff main`
   - If no git context → review all Swift files in the project

2. **Dispatch two review agents in parallel:**
   - `swift-reviewer` agent — Swift 6 concurrency, Liquid Glass, deprecated APIs, accessibility, performance
   - `code-reviewer` agent — plan adherence, code organization, error handling, test coverage (code-analyzer protocol)

3. **Merge findings:**
   - Deduplicate overlapping issues (both reviewers often catch the same root cause)
   - Unify severity: CRITICAL → MAJOR → MINOR → SUGGESTION
   - Preserve file:line references from both reviewers

4. **Grade the review:**
   - Count FAIL sections from code-analyzer output
   - Count CRITICAL findings from swift-reviewer
   - **A-:** 0 FAIL, 0 CRITICAL
   - **B:** 0 FAIL, 1-2 CRITICAL
   - **C:** 1+ FAIL
   - Report grade and whether it meets the Phase 5 exit criterion

5. **Present unified report** grouped by severity with actionable fixes
```

**Step 2: Verify the command exists and references both agents**
```bash
grep -c "swift-reviewer\|code-reviewer" commands/review.md
```
Expected: 4+ hits

**Step 3: Commit**
```bash
git add commands/review.md
git commit -m "feat: add /review command dispatching parallel swift-reviewer + code-reviewer"
```

---

### Task 3: Merge `swift-expert` into `macos-architect` and Delete

**Files:**
- Modify: `agents/macos-architect.md` — absorb Swift 6 concurrency content
- Delete: `agents/swift-expert.md`

**Step 1: Read both agent files**
Read `agents/swift-expert.md` and `agents/macos-architect.md`.

**Step 2: Identify unique content in `swift-expert` not already in `macos-architect`**
The key sections to absorb:
- Swift 6 strict concurrency migration patterns (if not already covered)
- `@MainActor` ViewModel patterns
- `Sendable` guidance
- Modern API replacements table (if more comprehensive than what macos-architect has)

**Step 3: Add unique content to `macos-architect.md`**
Append a "Swift 6 Concurrency" section to `macos-architect.md` with the absorbed content. Remove the dead "Integration with other agents" section that references non-existent agents.

**Step 4: Delete `agents/swift-expert.md`**
```bash
rm agents/swift-expert.md
```

**Step 5: Verify no references to swift-expert remain**
```bash
grep -r "swift-expert" agents/ skills/ commands/ CLAUDE.md README.md
```
Expected: zero hits (or only in plan docs)

**Step 6: Commit**
```bash
git add agents/macos-architect.md
git rm agents/swift-expert.md
git commit -m "refactor: merge swift-expert into macos-architect, delete duplicate agent"
```

---

### Task 4: Add `macos-architect` Validation Gate to `/feature-dev`

**Files:**
- Modify: `commands/feature-dev.md` — add Step 3 after code-architect

**Step 1: Read the current `/feature-dev` command**
Read `commands/feature-dev.md` and locate Phase 4 (Architecture Design).

**Step 2: Add the validation gate**
After the code-architect dispatch and user selection, add:

```markdown
### Step 3: Architecture Validation

Dispatch `macos-architect` agent to validate the selected architecture:
- Check navigation pattern fits the app archetype (library, document, utility)
- Verify state management approach (actors vs @MainActor, persistence layer)
- Check concurrency safety (Swift 6 strict mode compatibility)
- Validate Liquid Glass fit (where glass effects are appropriate)

If `macos-architect` flags BLOCKER issues → return to Step 2 with revised constraints.
If WARNINGS only → note them and proceed to implementation.
```

**Step 3: Also update Phase 6 to use `/review` instead of generic `code-reviewer`**
Replace the quality review dispatch with: "Run `/review` command for the review swarm."

**Step 4: Commit**
```bash
git add commands/feature-dev.md
git commit -m "feat: add macos-architect validation gate and /review swarm to feature-dev"
```

---

### Task 5: Add Platform Detection to `/implement-component`

**Files:**
- Modify: `commands/implement-component.md` — add platform detection before Step 1

**Step 1: Read current command**
Read `commands/implement-component.md`.

**Step 2: Add platform detection section before the workflow**
Insert before "1. Read the spec":

```markdown
## Platform Detection

Before implementing, determine the target platform:
1. Check `.xcodeproj` or `Package.swift` for deployment target (macOS vs iOS)
2. Check existing imports: `AppKit`/`NSApplication` = macOS, `UIKit`/`UIApplication` = iOS
3. Dispatch the appropriate agent:
   - **macOS target:** `ui-developer` agent (loads swiftui-expert-skill, swiftui-components, macos-app-design)
   - **iOS target:** `ios-developer` agent (loads ios-testing, swiftui-expert-skill, swiftui-presentation-api)
   - **Universal:** Both agents in parallel, each handling their platform layer
   - **Unknown:** Ask the user which platform to target
```

**Step 3: Commit**
```bash
git add commands/implement-component.md
git commit -m "feat: add platform detection and agent dispatch to implement-component"
```

---

### Task 6: Fix Skill Deficiencies

**Files:**
- Modify: `skills/app-development-workflow/SKILL.md` — Phase 0 scaffolding reference
- Modify: `skills/swiftui-components/SKILL.md` — remove phantom files from directory tree

**Step 1: Wire Xcode scaffolding into Phase 0**
In `app-development-workflow/SKILL.md` Phase 0, add after "Define scope":
```markdown
3. **Scaffold the project:**
   - If XcodeBuildMCP available: use `scaffold_macos_project` or `scaffold_ios_project` tool
   - If CLI: use `xcodebuild` with `xcodebuildmcp-cli` skill patterns
   - If Swift Package: create `Package.swift` targeting the appropriate platform version
   - Reference: `xcodebuildmcp` or `xcodebuildmcp-cli` skill for scaffolding commands
```

**Step 2: Remove phantom files from `swiftui-components/SKILL.md`**
In the File Structure section, remove these three lines:
- `│   ├── navigation.md`
- `│   ├── platform_bridging.md`
- `│   ├── app_structure.md`

**Step 3: Commit**
```bash
git add skills/app-development-workflow/SKILL.md skills/swiftui-components/SKILL.md
git commit -m "fix: wire scaffolding into Phase 0, remove phantom file listings"
```

---

### Task 7: Add `Grep`/`Glob` to `ios-developer` Agent

**Files:**
- Modify: `agents/ios-developer.md` — add Grep and Glob to tools

**Step 1: Read agent file**
Read `agents/ios-developer.md` frontmatter.

**Step 2: Add Grep and Glob to tools list**
Change `tools: Read, Write, Edit, Bash` to `tools: Read, Write, Edit, Bash, Grep, Glob`

UIKit bridging work requires searching for existing patterns (finding UIKit imports, locating delegate conformances, etc.). Without Grep/Glob the agent can't search the codebase.

**Step 3: Commit**
```bash
git add agents/ios-developer.md
git commit -m "fix: add Grep and Glob tools to ios-developer agent for codebase search"
```

---

### Task 8: Update CLAUDE.md, README.md, plugin.json

**Files:**
- Modify: `CLAUDE.md` — add review-fix loop, remove swift-expert, add /review
- Modify: `README.md` — same updates, fix agent table, add /review command
- Modify: `plugin.json` — version bump to 1.5.0

**Step 1: Update CLAUDE.md Phase 5**
Add "iterative review-fix loop with A- exit criterion" language. Add `/review` to Phase 5 commands. Remove `swift-expert` from any mentions. Ensure `swift-concurrency` is listed in Phase 5 review skills.

**Step 2: Update README.md**
- Remove `swift-expert` from agent table
- Add `/review` to Code Quality commands section
- Update `ios-developer` tools to `Read/Write/Edit/Bash/Grep/Glob`
- Add note about subagent sandbox limitation in a "Known Limitations" section

**Step 3: Bump plugin.json**
Change version from `1.4.0` to `1.5.0`. Update description to mention the review-fix loop.

**Step 4: Commit**
```bash
git add CLAUDE.md README.md plugin.json
git commit -m "docs: update lifecycle map for v1.5, add /review command, remove swift-expert"
```

---

## Verification Checklist

After all tasks complete:

1. `grep -r "swift-expert" agents/ CLAUDE.md README.md` → zero hits
2. `ls commands/review.md` → exists
3. `grep "Exit criterion" skills/app-development-workflow/SKILL.md` → found
4. `grep "macos-architect" commands/feature-dev.md` → found
5. `grep "Platform Detection" commands/implement-component.md` → found
6. `grep "navigation.md\|platform_bridging.md\|app_structure.md" skills/swiftui-components/SKILL.md` → zero hits
7. `grep "Grep, Glob" agents/ios-developer.md` → found
8. `grep "1.5.0" plugin.json` → found
9. `wc -l commands/review.md` → 30+ lines
10. All 10 agents remain in `agents/` (swift-expert deleted, count goes from 11 to 10)

## Issues NOT Addressed (Deferred)

- **2.5 `/hookify` bypass:** Low priority — hookify works, just uses generic subagent instead of named agent
- **3.1 Subagent sandbox limitation:** Architectural constraint of Claude Code, not fixable in plugin. Added to README as known limitation.
- **4.3 Version tracking:** No mechanism exists to track which planned changes shipped. Manual version management continues.
